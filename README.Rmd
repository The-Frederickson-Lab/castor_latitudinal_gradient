---
title: "Castor_latitudinal_gradient"
author: "Pooja Nathan"
date: "`r Sys.Date()`"
output: github_document
---

##Latitudinal gradients in species interactions

In this study, we sampled populations of the castor plant, Ricinus communis, across a large latitudinal range in the Indian subcontinent to understand if, when the host species is kept constant, there is variation in mutualistic traits and interactions across latitude as posited by the biotic interactions hypothesis.

```{r importing packages, echo = FALSE}
library(dplyr)
library(tidyr)
library(knitr)
library(ggplot2)
library(ggspatial)
library(ggpubr)
library(cowplot)
library(gridExtra)
library(patchwork)
library(grid)
library(lavaan)
library(piecewiseSEM)
library(ggforce)
library(lme4)
library(car)
library(raster)
library(scales)
library(sf)
library(magick)
library(vegan)
library(ggrepel)
library(terra)
library(sp)
library(corrplot)
library(viridis)
library(geodata) 
library(lubridate)
library(DHARMa)
library(glmmTMB)
library(lmerTest)
library(MASS)
```

##Data cleaning

Now, let's import and clean all the trait and interaction data

```{r reading in and cleaning up data}

#Reading in plant traits dataset
morph <- read.csv("morph_natint_20May24.csv")

#rename columns as needed
morph <- morph %>%
  rename(
    Location         = Site,
    width            = Width.at.10.cm,
    fruitno          = Number.of.fruits,
    branchno         = Number.of.branches,
    EFNLB_raw        = `EFN...LB`,
    EFNS_raw         = `EFN...S`,
    EFNL_raw         = `EFN...L`,
    leaves_in_branch = Number.of.leaves.in.EFN.branch
  )

morph$Latitude <- as.numeric(morph$Latitude)
morph$Longitude <- as.numeric(morph$Longitude)
morph$Phenology <- as.factor(morph$Phenology)
morph$width <- as.numeric(morph$width)
morph$branchno <- as.numeric(morph$branchno)
morph$fruitno <- as.numeric(morph$fruitno)


#reading in nectary size dataset
efnarea <- read.csv("Nectary_areas.csv")
efnarea$Location <- as.factor(efnarea$Location)
efnarea$Nec_type <- as.factor(efnarea$Nec_type)
efnarea$Nec_type <- as.factor(efnarea$Nec_type)
names(efnarea)[names(efnarea) == "PlantID"] <- "Plant.ID"

#Clean up, average when multiple measurements are available for the same individual/type of EFN
efnarea <- efnarea %>%
  group_by(Plant.ID, Nec_type) %>%
  summarize(
    Area = mean(Area, na.rm = TRUE),
    Location = first(Location)
  )

#converting to wideform

efnarea <- efnarea %>%
  pivot_wider(names_from = Nec_type, values_from = Area, 
              names_prefix = "Area_") %>%
  dplyr::select(Plant.ID, Area_Leafbase, Area_Petiole, Location)

#Reading in nectar volume dataset
volume <- read.csv("Nectary_volume.csv")

#volume <- merge(volume, lat, by = "Location")
names(volume)[names(volume) == "Drop.Volume..mm.3."] <- "dropvol"
names(volume)[names(volume) == "Location.on.Plant"] <- "Type"


volume <- volume %>% 
  group_by(Plant.ID, Type) %>% 
  summarise(meanvol = mean(dropvol, na.rm = TRUE),
    Location = first(Location)) 

#converting to wideform
volume <- volume %>%
  pivot_wider(names_from = Type, values_from = meanvol, 
              names_prefix = "Vol_") %>%
  dplyr::select(Plant.ID, Vol_Leafbase, Vol_Petiole, Location)

#Reading in seed dataset
seeds <- read.csv("Seed and elaiosome weights.csv")
names(seeds)[names(seeds) == "Site"] <- "Location"
names(seeds)[names(seeds) == "Seed.weight..g."] <- "seedweight"
names(seeds)[names(seeds) == "Elaiosome.seed"] <- "ratio"
#seeds <- merge(seeds, lat, by = "Location")

#Reading in average ant abundance by plant
#Calculated in the ant abundance analysis
#Different R script
ant_ab <- read.csv("ant_ab_by_plant.csv")

morphseed <- left_join(morph, seeds, by = "Plant.ID")
morphants <- left_join(morphseed, ant_ab, by = "Plant.ID")
morphants$average_abundance[is.na(morphants$average_abundance)] <- 0

#combining all data into one unified dataset
all_comb <- left_join(morphants, efnarea, by = "Plant.ID")
all_comb <- left_join(all_comb, volume, by = "Plant.ID")

#removing unneeded columns
data <- all_comb[, c(1:4, 6:27, 30:35, 37, 40, 41, 43, 44)]                         
names(data)[names(data) == "Location.x"] <- "Location"                      

```

##Statistical models

```{r correlations and data summary}

png("efn_correlations.png")
corrplot::corrplot(cor(data[, c("EFNLB", "EFNS", "EFNL", "Area_Leafbase", "Area_Petiole", "Vol_Leafbase", "Vol_Petiole")], use="pairwise.complete.obs"))
dev.off()

#EFN volumes are correlated to EFN areas
#Calculate R^2 and p-value for Area_Leafbase vs Vol_Leafbase
model1 <- lm(log10(Vol_Leafbase) ~ log10(Area_Leafbase), data = data)
r_squared1 <- summary(model1)$r.squared
p_value1 <- summary(model1)$coefficients[2, 4]

area_volume_cor1 <- ggplot(data=data, aes(x=Area_Leafbase, y=Vol_Leafbase)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  xlab("Leaf base EFNs (area, mm2)") +
  ylab("Leaf base EFNs (volume, mm3)") +
  geom_smooth(method="lm") +
  theme_cowplot() +
  annotate("text", x=2, y=2, label=paste("R^2 =", round(r_squared1, 3), "\nP =", signif(p_value1, 3)), hjust=0)

#Calculate R^2 and p-value for Area_Petiole vs Vol_Petiole
model2 <- lm(log10(Vol_Petiole) ~ log10(Area_Petiole), data = data)
r_squared2 <- summary(model2)$r.squared
p_value2 <- summary(model2)$coefficients[2, 4]

area_volume_cor2 <- ggplot(data=data, aes(x=Area_Petiole, y=Vol_Petiole)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  xlab("Petiole EFNs (area, mm2)") +
  ylab("Petiole EFNs (volume, mm3)") +
  geom_smooth(method="lm") +
  theme_cowplot() +
  annotate("text", x=2, y=2, label=paste("R^2 =", round(r_squared2, 3), "\nP =", signif(p_value2, 3)), hjust=0)

area_volume <- plot_grid(area_volume_cor1, area_volume_cor2, labels=c("A) Leaf base EFNs", "B) Petiole EFNs"))

ggsave(filename = "efn_area_volume_correlation.png", plot = area_volume, width = 12, height = 7, dpi = 300)

#correlations between branch number and width
model3 <- lm(width ~ branchno, data = data)
r_squared3 <- summary(model3)$r.squared
p_value3 <- summary(model3)$coefficients[2, 4]

width_branchno_cor <- ggplot(data=data, aes(x=branchno, y=width)) +
  geom_point() +
  xlab("Number of branches") +
  ylab("Stem width (plant age, cm)") +
  geom_smooth(method="lm") +
  theme_cowplot() +
  annotate("text", x=2, y=2, label=paste("R^2 =", round(r_squared3, 3), "\nP =", signif(p_value3, 3)), hjust=0)


ggsave(filename = "width_branchno.png", plot = width_branchno_cor, width = 7, height = 7, dpi = 300)

#Does width vary with latitude?
lm_width <- lm(width ~ Latitude, data = data)
r_squared4 <- summary(lm_width)$r.squared
p_value4 <- summary(lm_width)$coefficients[2, 4]

#marginally significant
width_lat_cor <- ggplot(data=data, aes(x=Latitude, y=width)) +
  geom_point() +
  xlab("Latitude") +
  ylab("Stem width (cm)") +
  geom_smooth(method="lm") +
  theme_cowplot() +
  annotate("text", x=2, y=2, label=paste("R^2 =", round(r_squared4, 3), "\nP =", signif(p_value4, 3)), hjust=0)

ggsave(filename = "width_lat.png", plot = width_lat_cor, width = 7, height = 7, dpi = 300)

#Number of plants at each site
data$Location <- as.factor(data$Location)

plantnos <- data %>%
  group_by(Location) %>%
  summarise(Number_of_Plants = n_distinct(Plant.ID))

```

Statistical modelling 

We will now use linear models and multivariate linear models where appropriate 

```{r calculating urbanization scores}

#removing Kenya datapoints and island site
data <- data[!data$Location %in% c("Rumuruti1", "Rumuruti2", "Portblair"), ]

#Calculating a measure of urbanization for each site
#first calculate the centroid for each site
dat_no_latNAs <- data %>% 
  filter(!is.na(Longitude) & !is.na(Latitude))

pts <- st_as_sf(dat_no_latNAs,
                coords = c("Longitude", "Latitude"),
                crs    = 4326,               # WGS‑84
                remove = FALSE) 

pts_eqarea <- st_transform(pts, 8857) #India has more than one UTM zone

centroids_proj <- pts_eqarea %>% 
  group_by(Location) %>%                    
  summarise(geometry = st_centroid(st_union(geometry)),
            .groups  = "drop")

centroids_ll <- centroids_proj %>% 
  st_transform(4326) %>%                    # back to WGS‑84
  mutate(long_centroid = st_coordinates(.)[, 1],
         lat_centroid  = st_coordinates(.)[, 2]) %>% 
  st_drop_geometry() 


#add urbanization scores from software 
centroids_ll$urb <- c(3.11499,0.6754, 2.89652, -0.2998, -1.1211, -0.6686, -2.815, -0.5959, -1.16525, -0.02087)

#now merge with main dataset
data <- data %>% 
  left_join(centroids_ll, by = "Location") 

p_urb <- ggplot(centroids_ll, aes(x = lat_centroid, y = urb)) +
  geom_point(size = 4, color = "olivedrab") +
  geom_smooth(method = "lm", se = FALSE, color = "grey40", linewidth = 1.5) +
  xlab("Latitude") +
  ylab("Urbanization score") +
  theme_classic(base_size = 14)

ggsave(filename = "urb_lat.png", plot = p_urb, width = 5, height = 4, dpi = 300)

lm_urb_lat <- lm(urb ~ lat_centroid, data = centroids_ll)
#No effect of latitude on urbanization

#Classifying as native, mainland and island sites
#data$Type <- ifelse(data$Location %in% c("Rumuruti1", "Rumuruti2"), "Native", 
                   #ifelse(data$Location == "Portblair", "Island", "Mainland"))

#write.csv(data, "data_20May.csv")

```

```{r linear models}

#data <- read.csv("data_20May.csv")

#Linear models

#Stem width at 10 cm used as a proxy for plant age

###EFN counts

#Leaf base EFN

#Using the standardized counts per leaf
lm_efnlb <- lm(EFNLB ~ Latitude + width, data = data)
sim_res <- simulateResiduals(fittedModel = lm_efnlb, n = 1000)
plot(sim_res)
summary(lm_efnlb)
#assumptions violated

#Using poisson family distribution on raw EFN counts
lm_efnlb1 <- glm(EFNLB_raw ~ Latitude + width +  offset(log(leaves_in_branch)),
                   data = data,
                   family = poisson)

summary(lm_efnlb1)

sim_res <- simulateResiduals(fittedModel = lm_efnlb1, n = 1000)
plot(sim_res)
#assumptions violated

lm_efnlb2 <- glm.nb(EFNLB_raw ~ Latitude + width +  offset(log(leaves_in_branch)),
                   data = data)

summary(lm_efnlb2)

sim_res <- simulateResiduals(fittedModel = lm_efnlb2, n = 1000)
plot(sim_res)
#Final model

#Stem EFNs
lm_efns <- glm(EFNS ~ Latitude + width,
                   data = data)
summary(lm_efns)

sim_res <- simulateResiduals(fittedModel = lm_efns, n = 1000)
plot(sim_res)
#This is not bad

#Trying model structure as in leaf base EFNs for consistency
lm_efns1 <- glm.nb(EFNS_raw ~ Latitude + width +  offset(log(leaves_in_branch)),
                   data = data)

summary(lm_efns1)

sim_res <- simulateResiduals(fittedModel = lm_efns1, n = 1000)
plot(sim_res)
#Better than poisson model but worse than EFNS used directly

###EFN areas

#Leaf base EFNs
lm_efna_lb <- lm(Area_Leafbase ~ Latitude + width, data = data)
summary(lm_efna_lb)
sim_res <- simulateResiduals(fittedModel = lm_efna_lb, n = 1000)
plot(sim_res)
#final model

lm_efna_s <- lm(Area_Petiole ~ Latitude + width, data = data)
summary(lm_efna_s)
sim_res <- simulateResiduals(fittedModel = lm_efna_s, n = 1000)
plot(sim_res)
#final model

#Examining correlations between EFN areas and volumes
lm6 <- lm(Vol_Leafbase ~ Area_Leafbase, data = data) 
summary(lm6)

lm7 <- lm(Vol_Petiole ~ Area_Petiole, data = data)
summary(lm7)

#EFN areas and volumes are highly correlated
#Because we had only a small number of volume measurements 
#And because they are correlated, we used areas as a proxy for investment

#Herbivory
lm_herb <- lm(pherb ~ Latitude + width + average_abundance, 
          data = data)
sim_res <- simulateResiduals(fittedModel = lm_herb, n = 1000)
plot(sim_res)

summary(lm_herb)
#final model

#ant abundance
lm_ants <- lm(average_abundance ~ Latitude + width, 
          data = data)

sim_res <- simulateResiduals(fittedModel = lm_ants, n = 1000)
plot(sim_res)

summary(lm_ants)
#many model assumptions violated

#log transformed ant abundance
lm_ants1 <- lm(log(average_abundance+1) ~ Latitude + width, data = data)

sim_res <- simulateResiduals(fittedModel = lm_ants1, n = 1000)
plot(sim_res)

summary(lm_ants1)
#Better but can be improved
#final model


#Seed mass, elaiosome mass

#mlm3 <- lm(cbind(seedweight, elaiosome.weight) ~ Latitude + width, data = data)
#summary(mlm3)
#Anova(mlm3)

#lm12 <- lm(ratio ~ Latitude + width, data = data)
#summary(lm12)

#Fitness
#lm13 <- lm(fruitno ~ Latitude + width + branchno + pherb + Type, data = data)
#summary(lm13)

```
```{r rerunning the models using worldclim data}

#I don't think this is necessary
data_clean <- data %>% 
  mutate(Timestamp = dmy_hms(Timestamp, tz = "UTC"))       

#Creating a SpatVector
pts <- vect(data_clean,
            geom = c("Longitude", "Latitude"),
            crs  = "EPSG:4326")    # WGS‑84 lat/long

#Download worldclim data
dl_dir <- file.path(getwd(), "worldclim_cache")
dir.create(dl_dir, showWarnings = FALSE)
bio  <- worldclim_global(var = "bio",  res = 2.5, path = dl_dir)   
tmax <- worldclim_global(var = "tmax", res = 2.5, path = dl_dir)
tmin <- worldclim_global(var = "tmin", res = 2.5, path = dl_dir)
prec <- worldclim_global(var = "prec", res = 2.5, path = dl_dir)

#Summarize monthly stacks
ann_tmax <- app(tmax, fun = max)     # hottest month
ann_tmin <- app(tmin, fun = min)     # coldest month
ann_prec <- app(prec, fun = sum)     # annual precip (mm)

names(ann_tmax) <- "ann_tmax"        # hottest‑month Tmax (°C × 10)
names(ann_tmin) <- "ann_tmin"        # coldest‑month Tmin (°C × 10)
names(ann_prec) <- "annual_precip"   # yearly precip (mm)

#extract for my coordinates
bio_vals <- extract(bio, pts) %>% as.data.frame() %>% dplyr::select(-ID)
tmax_vals <- extract(ann_tmax, pts) %>% as.data.frame() %>% dplyr::select(-ID)
tmin_vals <- extract(ann_tmin, pts) %>% as.data.frame() %>% dplyr::select(-ID)
prec_vals <- extract(ann_prec, pts) %>% as.data.frame() %>% dplyr::select(-ID)

df_clim <- bind_cols(data_clean, bio_vals, tmax_vals, tmin_vals, prec_vals) %>%
  mutate(across(c(ann_tmax, ann_tmin, starts_with("wc2.1_2.5m_bio_")),
                ~ .x / 10)) #woldclim shows x10 values

#Visualizing correlations between climate variables and latitude

png("efn_correlations.png")
corrplot::corrplot(cor(df_clim[, c("ann_tmax", "ann_tmin", "annual_precip", "Latitude" )], use="pairwise.complete.obs"))
dev.off()

#ann_tmax, ann_tmin and latitude are correlated
#ann_precip seems relatively uncorrelated so can be added to existing models
#So we will run one set of models with latitude + precip 
#And another with just max or min temp

#Leaf base EFN

#Using poisson family distribution on raw EFN counts
lm_efnlb3 <- glm(EFNLB_raw ~ Latitude + width + annual_precip + offset(log(leaves_in_branch)),
                   data = df_clim,
                   family = poisson)

summary(lm_efnlb3)

sim_res <- simulateResiduals(fittedModel = lm_efnlb3, n = 1000)
plot(sim_res)
#final model for precipitation

#For temperature and precipitation
#Using tmin because plants are more sensitive to cold temperatures

lm_efnlb4 <- glm(EFNLB_raw ~  width + ann_tmin + annual_precip + 
                      offset(log(leaves_in_branch)), 
                 data = df_clim, family = poisson)

summary(lm_efnlb4)

sim_res <- simulateResiduals(fittedModel = lm_efnlb4, n = 1000)
plot(sim_res)
#final model

#Stem EFNs

#precipitation
lm_efns2 <- lm(EFNS ~ Latitude + width + annual_precip, data = df_clim)

summary(lm_efns2)

sim_res <- simulateResiduals(fittedModel = lm_efns2, n = 1000)
plot(sim_res)
#diagnostic plots best
#final model

#temperature + precipitation

lm_efns3 <- glm(EFNS ~  width + ann_tmin + annual_precip, data = df_clim)
summary(lm_efns3)

sim_res <- simulateResiduals(fittedModel = lm_efns3, n = 1000)
plot(sim_res)
#final model

#EFN areas

#Leaf base EFNs

#precipitation

lm_efna_lb1 <- lm(Area_Leafbase ~ Latitude + width + annual_precip, data = df_clim)
summary(lm_efna_lb1)
sim_res <- simulateResiduals(fittedModel = lm_efna_lb1, n = 1000)
plot(sim_res)
#final model

#temperature + precipitation
lm_efna_lb2 <- lm(Area_Leafbase ~  width + ann_tmin + annual_precip, data = df_clim)
summary(lm_efna_lb2)
sim_res <- simulateResiduals(fittedModel = lm_efna_lb2, n = 1000)
plot(sim_res)
#final model

#petiole EFNs

#precipitation

lm_efna_s1 <- lm(Area_Petiole ~ Latitude + width + annual_precip, data = df_clim)
summary(lm_efna_s1)
sim_res <- simulateResiduals(fittedModel = lm_efna_s1, n = 1000)
plot(sim_res)
#final model

#temperature + precipitation
lm_efna_s2 <- lm(Area_Petiole ~  width + ann_tmin + annual_precip, data = df_clim)
summary(lm_efna_s2)
sim_res <- simulateResiduals(fittedModel = lm_efna_s2, n = 1000)
plot(sim_res)
#final model

#Herbivory

#precipitation
lm_herb1 <- lm(pherb ~ Latitude + width + average_abundance + annual_precip, 
          data = df_clim)
sim_res <- simulateResiduals(fittedModel = lm_herb1, n = 1000)
plot(sim_res)
summary(lm_herb1)
#final model

#temperature + precipitation
lm_herb2 <- lm(pherb ~  width + average_abundance + ann_tmin + annual_precip, 
          data = df_clim)
sim_res <- simulateResiduals(fittedModel = lm_herb2, n = 1000)
plot(sim_res)
summary(lm_herb2)
#final model

#ant abundance

#precipitation

#log transformed ant abundance
lm_ants2 <- lm(log(average_abundance+1) ~ Latitude + width + annual_precip, 
          data = df_clim)

sim_res <- simulateResiduals(fittedModel = lm_ants2, n = 1000)
plot(sim_res)

summary(lm_ants2)
#final model

#temperature + precipitation
lm_ants3 <- lm(log(average_abundance+1) ~  width + ann_tmin + annual_precip, 
          data = df_clim)

sim_res <- simulateResiduals(fittedModel = lm_ants3, n = 1000)
plot(sim_res)

summary(lm_ants3)
#final model
```

##Visualizing the data

Extrafloral nectaries 

```{r EFNs}

base_size <- 10

#Extracting coefficients and p-values from linear models
intercept_efnlb <- coef(lm_efnlb2)["(Intercept)"]
slope_latitude_efnlb <- coef(lm_efnlb2)["Latitude"]
summary_efnlb <- summary(lm_efnlb2)
p_value_latitude_efnlb <- summary_efnlb$coefficients["Latitude", "Pr(>|z|)"]

#Leafbase EFNs
p_efn_lb_1 <- ggplot(data, aes(x = Latitude, y = log(EFNLB+1))) +  
  geom_jitter(alpha = 0.7, width = 0.1, height = 0.1, size = 3.5, color = "olivedrab") +
  xlab("Latitude") +
  ylab("Log(Leaf base EFNs (no./leaf) +1)") +
  scale_x_continuous(limits = c(min(data$Latitude), 30)) +
  theme_classic() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(size = base_size * 1.7),
    axis.title = element_text(size = base_size * 1.4),
    axis.text = element_text(size = base_size * 1.3),
    legend.position = "none",
    plot.margin = margin(10, 10, 10, 10)
  ) +
  geom_abline(intercept = intercept_efnlb, slope = slope_latitude_efnlb,
              color = "slategrey", linewidth = 2)+
  annotate("text", x = 19, 
           y = max(1.35, na.rm = TRUE),
           label = "*", 
           size = 12, 
           color = "black")


#ggsave(filename = "efnlb.png", plot = combined_plot_efnlb, width = 10, height = 7, dpi = 300)

#Stem EFNs - non-significant
p_efn_s_1 <- ggplot(data, aes(x = Latitude, y = log(EFNS+1))) +  
  geom_jitter(alpha = 0.7, width = 0.1, height = 0.1, size = 3.5, color = "olivedrab") +
  xlab("Latitude") +
  ylab("Log(Petiole EFNs (no./leaf) + 1)") +
  scale_x_continuous(limits = c(min(morph$Latitude), 30)) +
  theme_classic() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(size = base_size * 1.7),
    axis.title = element_text(size = base_size * 1.4),
    axis.text = element_text(size = base_size * 1.3),
    legend.position = "none",
    plot.margin = margin(10, 10, 10, 10)
  ) 

#ggsave(filename = "efns.png", plot = combined_plot_efns, width = 10, height = 7, dpi = 300)

#EFN areas

#Leaf base EFNs
intercept_aefnlb <- coef(lm_efna_lb)["(Intercept)"]
slope_latitude_aefnlb <- coef(lm_efna_lb)["Latitude"]

p_area_lb <- ggplot(data = data, aes(x = Latitude, y = Area_Leafbase)) +  
  geom_jitter(alpha = 0.7, width = 0.1, height = 0.1, size = 3.5, color = "olivedrab") +
  xlab("Latitude") +
  ylab("Leaf base EFN area (mm²)") +
  scale_x_continuous(limits = c(min(data$Latitude, na.rm = TRUE), 30)) +
  theme_classic() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(size = base_size * 1.7),
    axis.title = element_text(size = base_size * 1.4),
    axis.text = element_text(size = base_size * 1.3),
    legend.position = "none",
    plot.margin = margin(10, 10, 10, 10)
  ) +
  geom_abline(
    intercept = intercept_aefnlb,
    slope = slope_latitude_aefnlb,
    color = "slategrey",
    size = 2
  ) +
  annotate(
    "text",
    x = 19,
    y = max(9.5, na.rm = TRUE),
    label = "*",
    size = 12,
    color = "black"
  )

#ggsave(filename = "arealb.png", plot = combined_plot_arealb, width = 10, height = 7, dpi = 300)

#Petiole EFNs
intercept_aefns <- coef(lm_efna_s)["(Intercept)"]
slope_latitude_aefns <- coef(lm_efna_s)["Latitude"]

p_area_s <- ggplot(data = data, aes(x = Latitude, y = Area_Petiole)) +  
  geom_jitter(alpha = 0.7, width = 0.1, height = 0.1, size = 3.5, color = "olivedrab") +
  xlab("Latitude") +
  ylab("Petiole EFN area (mm²)") +
  scale_x_continuous(limits = c(min(data$Latitude, na.rm = TRUE), 30)) +
  theme_classic() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(size = base_size * 1.7),
    axis.title = element_text(size = base_size * 1.4),
    axis.text = element_text(size = base_size * 1.3),
    legend.position = "none",
    plot.margin = margin(10, 10, 10, 10)
  ) +
  geom_abline(
    intercept = intercept_aefns,
    slope = slope_latitude_aefns,
    color = "slategrey",
    size = 2
  ) +
  annotate(
    "text",
    x = 19,
    y = max(7.5, na.rm = TRUE),
    label = "*",
    size = 12,
    color = "black"
  )

#ggsave(filename = "areas.png", plot = combined_plot_areas, width = 10, height = 7, dpi = 300)
```


```{r Herbivory and ant visits}

#Herbivory

intercept_herb <- coef(lm_herb)["(Intercept)"]
slope_latitude_herb <- coef(lm_herb)["Latitude"]

p_herb1 <- ggplot(data = data, aes(x = Latitude, y = pherb)) +
  geom_jitter(
    alpha = 0.7,
    width = 0.1,
    height = 0.1,
    size = 3.5,
    color = "olivedrab"
  ) +
  xlab("Latitude") +
  ylab("Proportion of leaves with herbivory") +
  scale_x_continuous(limits = c(min(data$Latitude, na.rm = TRUE), 30)) +
  theme_classic() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(size = base_size * 1.7),
    axis.title = element_text(size = base_size * 1.4),
    axis.text = element_text(size = base_size * 1.3),
    legend.position = "none",
    plot.margin = margin(10, 10, 10, 10)
  ) +
  geom_abline(
    intercept = intercept_herb,
    slope = slope_latitude_herb,
    color = "slategrey",
    size = 2
  ) +
  annotate(
    "text",
    x = 19,
    y = max(data$pherb, na.rm = TRUE),
    label = "*",
    size = 12,
    color = "black"
  )

#ggsave(filename = "herb.png", plot = combined_plot_herb, width = 12, height = 7, dpi = 300)


#ant visitation rates
intercept_ant <- coef(lm_ants1)["(Intercept)"]
slope_latitude_ant <- coef(lm_ants1)["Latitude"]

p_ants1 <- ggplot(data = data, aes(x = Latitude, y = log(average_abundance+1))) +
  geom_jitter(
    alpha = 0.7,
    width = 0.1,
    height = 0.1,
    size = 3.5,
    color = "olivedrab"
  ) +
  xlab("Latitude") +
  ylab("Log(Average ant visits (no./leaf) +1)") +
  scale_x_continuous(limits = c(min(data$Latitude, na.rm = TRUE), 30)) +
  theme_classic() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(size = base_size * 1.7),
    axis.title = element_text(size = base_size * 1.4),
    axis.text = element_text(size = base_size * 1.3),
    legend.position = "none",
    plot.margin = margin(10, 10, 10, 10)
  ) +
  geom_abline(
    intercept = intercept_ant,
    slope = slope_latitude_ant,
    color = "slategrey",
    size = 2
  ) +
  annotate(
    "text",
    x = 19,
    y = max(3.5, na.rm = TRUE),
    label = "*",
    size = 12,
    color = "black"
  )

#ggsave(filename = "combined_plot_ants.png", plot = combined_plot_ants, width = 12, height = 7, dpi = 300)

```

```{r Making Fig. 1 and 2}
#Figure 1
#Read shapefile
#shapefile_path <- "gadm41_IND_shp/gadm41_IND_0.shp"
shapefile_path <- "India_Country_Boundary.shp"
india <- st_read(shapefile_path)
 

#Set latitude and longitude of sites
Site <- c("Ramnagar", "Aligarh", "Gwalior", "Bhopal","Nagpur", "Hyderabad", 
          "Hampi", "Bangalore", "Srirangam", "Kanyakumari" )
Lat <- c(29.40, 27.89, 26.23, 23.22, 21.25, 17.33, 15.34, 13.07, 10.86, 8.08)
Lon <- c(79.13, 78.03, 78.26, 77.38, 79.08, 78.44, 76.46, 77.53, 78.70, 77.52)

sites <- data.frame(Site, Lat, Lon)

sites_sf <- st_as_sf(sites, coords = c("Lon", "Lat"), crs = 4326)

degree_label <- function(x) {
  paste0(x, "\u00B0")
}
# Transform india and sites_sf to UTM (select appropriate zone for India)
india <- st_transform(india, crs = 32644) # UTM Zone 44N (adjust for your region)
sites_sf <- st_transform(sites_sf, crs = 32644)

# Redraw the map
indmap <- ggplot(data = india) +
  geom_sf() +
  geom_sf(data = sites_sf, aes(color = "olivedrab"), size = 3.5) +
  scale_x_continuous(labels = degree_label) +
  scale_y_continuous(labels = degree_label) +
  labs(x = "Longitude", y = "Latitude") +
  theme_minimal() +
  scale_color_identity() + 
  annotation_scale(location = "bl", width_hint = 0.2) +  # Scale bar in bottom left
  annotation_north_arrow(location = "tl",                # Compass rose in top left
                         which_north = "true",           # True north
                         pad_x = unit(0.5, "cm"), 
                         pad_y = unit(0.5, "cm"),
                         style = north_arrow_fancy_orienteering())


#Add it to the map

ggsave("Indiamap.png", indmap, width = 8, height = 6)


###Figure 2
#Combine the second row with 4 plots
second_row <- (p_efn_lb_1 + p_efn_s_1) +
  plot_layout(ncol = 2)

#Combine the third row with 2 plots
third_row <- (p_area_lb + p_area_s) +
  plot_layout(ncol = 2)

fourth_row <- (p_herb1 + p_ants1) +
  plot_layout(ncol = 2)

#Combine the three rows into one layout
combined_plot <-  second_row / third_row / fourth_row

#Annotate with labels for subplots (a-i)
final_plot <- combined_plot +
  plot_annotation(tag_levels = 'a')  # Labels from a onwards


# Save the final plot to a file
ggsave("figure2.png", final_plot, width = 11.5, height = 12)

```

How does seed size and elaiosome/seed mass vary across latitude?

Not in paper

```{r seeds}
#How does seed size and elaiosome weight vary across latitude?

#Seeds were placed on scale and total weight was divided by number of seeds
#For each source plant

#Seed weight
p_seedwt <- ggplot(data = data, aes(x = Latitude, y = seedweight)) +
  geom_point(position = position_jitter(width = 0.2), alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, color = "saddlebrown") +
  xlab("Latitude") +
  ylab("Seed weight") +
  ggtitle("Variation in seed weight across latitude") 

#Seed to elaiosome weight ratio
p_seedrat <- ggplot(data = data, aes(x = Latitude, y = ratio)) +
  geom_point(position = position_jitter(width = 0.2), alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, color = "saddlebrown") +
  xlab("Latitude") +
  ylab("Elaiosome weight to seed weight ratio") +
  ggtitle("Variation in e/s ratio across latitude") 
  

```

Visualizing plant traits

Not in paper

```{r Plant traits}
#How do plant traits vary across latitude?


#Stem width
p_width <- ggplot(data = data, aes(x = Latitude, y = width)) +
  geom_point(position = position_jitter(width = 0.2), alpha = 0.5) +
  stat_summary(fun.data = "median_hilow", geom = "errorbar", width = 0.2) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  xlab("Latitude") +
  ylab("Stem width at 10 cm") +
  ggtitle("Variation in stem width with latitude") 


#Branches
p_branch <- ggplot(data = data, aes(x = Latitude, y = as.numeric(branchno))) +
  geom_point(position = position_jitter(width = 0.2), alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  xlab("Latitude") +
  ylab("Number of branches") +
  ggtitle("Variation in no. of branches with latitude") 

#Heights
p_height <- ggplot(data = data, aes(x = Latitude, y = as.numeric(Height))) +
  geom_point(position = position_jitter(width = 0.2), alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  xlab("Latitude") +
  ylab("Plant height") +
  ggtitle("Variation in plant height with latitude") 

#leaf size
p_leaf <- ggplot(data = data, aes(x = Latitude, y = areaavg)) +  
  geom_point( alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, color = "olivedrab") +
  xlab("Latitude") +
  ylab("Proxy of leaf area") +
  ggtitle("Variation in leaf size across latitude") +
  scale_y_continuous(limits = c(min(morph$areaavg), max(morph$areaavg)))


#fruitsize
p_fruit <- ggplot(data = data, aes(x = Latitude, y = Fruit_size_avg)) +  
  geom_point( alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, color = "olivedrab") +
  xlab("Latitude") +
  ylab("Radius of fruits") +
  ggtitle("Variation in fruit size across latitude") +
  scale_y_continuous(limits = c(min(morph$Fruit_size_avg), max(morph$Fruit_size_avg)))


#number of fruits
p_fit <- ggplot(data = data, aes(x = Latitude, y = fruitno)) +
  geom_point(position = position_jitter(width = 0.2), alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, color = "slateblue") +
  xlab("Latitude") +
  ylab("Number of fruits") 


```
##Ant community analysis


Here, we will generate some plots to understand how scan number and and number of days scanned affect ant abundance data trends. Inferences from these plots will be used to control for sampling effort in the main data analysis of this study.

```{r Exploratory plots}
ants <- read.csv("Ant_abundance_all_natint_20May24.csv") #read in the abundance dataset
ants$Site <- as.factor(ants$Site) 

#Making sure formats are correct
ants$number1 <- as.numeric(as.character(ants$number1))
ants$number2 <- as.numeric(as.character(ants$number2))
ants$number3 <- as.numeric(as.character(ants$number3))
ants$number4 <- as.numeric(as.character(ants$number4))

#Removing Kenya points
ants <- ants %>%
  filter(!Site %in% c("Rumuruti1", "Rumuruti2"))


#Convering to long form
ants_long_data <- ants%>%
  pivot_longer(
    cols = starts_with("species") | starts_with("number") | starts_with("feeding"),
    names_to = c(".value", "group"),
    names_pattern = "(species|number|feeding)(\\d)"
  ) %>% drop_na(species)

#Calculating cumulative species counts
cumulative_species_count <- ants_long_data %>%
  group_by(Plant.ID, scan_no) %>%
distinct(species, .keep_all = TRUE) %>%
  ungroup() %>%
arrange(Plant.ID, scan_no) %>%
  group_by(Plant.ID) %>%
mutate(cumulative_species = cumsum(!duplicated(species))) %>%
  ungroup()

stabilization_data <- cumulative_species_count %>%
  group_by(Site, scan_no) %>%  # Group by both Site and scan_no
  summarise(
    mean_species = mean(cumulative_species, na.rm = TRUE),
    sd_species = sd(cumulative_species, na.rm = TRUE),
    .groups = "drop"
  )


p <- ggplot() +
  # Site-level mean cumulative species line
  geom_line(
    data = stabilization_data, 
    aes(x = scan_no, y = mean_species, color = Site), 
    size = 1
  ) +
  # Ribbon for standard deviation
  geom_ribbon(
    data = stabilization_data, 
    aes(x = scan_no, ymin = mean_species - sd_species, ymax = mean_species + sd_species, fill = Site), 
    alpha = 0.2
  ) +
  geom_vline(xintercept = 6, linetype = "dashed", color = "red") +  # Highlight scan 6
  facet_wrap(~ Site, scales = "free_y") +  # Facet by site
  theme_minimal() +
  labs(
    title = "Average cumulative number of ant species by number of scans",
    x = "Number of Scans",
    y = "Mean Cumulative Number of Unique Species"
  ) +
  theme(legend.position = "none")

#6 scans

#Choosing how many days to include

species_per_plant <- ants_long_data %>%
  group_by(Site, Plant.ID, scan_day) %>%
  summarise(species_list = list(unique(species)), .groups = 'drop') %>%
  arrange(Site, Plant.ID, scan_day) %>%
  group_by(Site, Plant.ID) %>%
  mutate(
    cumulative_species_list = lapply(seq_along(species_list), function(x) unique(unlist(species_list[1:x]))),
    cumulative_species_count = sapply(cumulative_species_list, length)
  ) %>%
  ungroup()

# Summarize cumulative species counts across plants for each site
summary_species_per_day <- species_per_plant %>%
  group_by(Site, scan_day) %>%
  summarise(
    mean_cumulative_species = mean(cumulative_species_count, na.rm = TRUE),
    sd_cumulative_species = sd(cumulative_species_count, na.rm = TRUE),
    .groups = 'drop'
  )

# Plot individual plant curves and site-level summary
p_days_plants <- ggplot() +
  # Site-level mean cumulative species line
  geom_line(data = summary_species_per_day, 
            aes(x = scan_day, y = mean_cumulative_species, color = Site), 
            size = 1) +
  # Ribbon for standard deviation
  geom_ribbon(data = summary_species_per_day, 
              aes(x = scan_day, ymin = mean_cumulative_species - sd_cumulative_species, 
                  ymax = mean_cumulative_species + sd_cumulative_species, fill = Site), 
              alpha = 0.2) +
  facet_wrap(~ Site, scales = "free_x") +  # Facet by site
  theme_minimal() +
  labs(
    title = "Average cumulative ant species across scan days",
    x = "Scan Day",
    y = "Cumulative unique species count"
  ) +
  theme(legend.position = "none")


scans_days_plot <-  p / p_days_plants

#Annotate with labels for subplots (a-i)
scans_days_plot <- scans_days_plot +
  plot_annotation(tag_levels = 'A')

ggsave("figureS2.png", scans_days_plot, width = 7, height = 10)

#Generate a list of ant species seen at each site
ant_species_summary <- ants_long_data %>%
  group_by(Site) %>%
  summarise(Ant_Species = paste(unique(species), collapse = ", ")) %>%
  arrange(Site)

#View the summarized data
print(ant_species_summary)

unique_ant_species <- ants_long_data %>%
  dplyr::select(species) %>%
  distinct() %>%
  pull(species)

# Count the total number of unique species
total_ant_species <- length(unique_ant_species)


#Save the output to a CSV file
#write.csv(ant_species_summary, "ant_species_summary.csv", row.names = FALSE)
```


Using the vegan package to investigate how ant communities vary across latitude


```{r Community characteristics, echo=FALSE}
ants <- read.csv("Ant_abundance_all_natint_20May24.csv") #read in the abundance dataset

ants$number1 <- as.numeric(as.character(ants$number1))
ants$number2 <- as.numeric(as.character(ants$number2))
ants$number3 <- as.numeric(as.character(ants$number3))
ants$number4 <- as.numeric(as.character(ants$number4))

#Removing Kenya points
ants <- ants %>%
  filter(!Site %in% c("Rumuruti1", "Rumuruti2", "Portblair"))

ants_long_data <- ants%>%
  pivot_longer(
    cols = starts_with("species") | starts_with("number") | starts_with("feeding"),
    names_to = c(".value", "group"),
    names_pattern = "(species|number|feeding)(\\d)"
  ) %>% drop_na(species)

#this took out all the zero abundances

write.csv(ants_long_data, "ant_ab_all_long.csv")

#averaging across scans 1 to 6 for all days
averaged_data1 <- ants_long_data %>%
  filter(scan_no %in% 1:6) %>% 
  group_by(Plant.ID, scan_day, species) %>% #
  summarise(average_abundance = mean(number, na.rm = TRUE), .groups = 'drop') 

#Averaging across days for all plants
averaged_data2 <- averaged_data1 %>%
  group_by(Plant.ID, species) %>% 
  summarise(average_abundance = mean(average_abundance, na.rm = TRUE), .groups = 'drop') 


#merging to get site IDs and latitudes
site_lat_mapping <- ants_long_data %>%
  dplyr::select(Plant.ID, Site, Lat) %>% 
  distinct() 

final_data <- merge(averaged_data2, site_lat_mapping, all.x = TRUE, all.y = FALSE)

#Averaging for sites
averaged_data3 <- final_data %>%
  group_by(Site, Lat, species) %>% 
  summarise(average_abundance = mean(average_abundance, na.rm = TRUE), .groups = 'drop') 

species_abundance_matrix <- averaged_data3 %>%
  pivot_wider(names_from = species, values_from = average_abundance, values_fill = list(average_abundance = 0)) %>%
  dplyr::select(-Lat) %>%
  distinct()

latitude_data <- averaged_data3 %>%
  dplyr::select(Site, Lat) %>%
  distinct()

final_matrix <- left_join(species_abundance_matrix, latitude_data, by = "Site")


#Characterizing community composition
sp_arranged <- final_matrix %>% 
  dplyr::arrange(Lat)

sp_final  <- sp_arranged %>% 
  dplyr::select(-Lat, -Site)

#calculating diversity indices

simpson <- diversity(sp_final,index = "simpson")
shannon <- diversity(sp_final)
richness <- specnumber(sp_final)

par(mfrow = c(1, 2))  
plot(simpson)
plot(shannon)

par(mfrow = c(1, 2))  
hist(simpson)
hist(shannon)

diversity_data <- data.frame(
  Site = sp_arranged$Site,
  Latitude = sp_arranged$Lat,
  Shannon = shannon,
  Richness = richness
)

lm_shannon <- lm(Shannon ~ Latitude, data = diversity_data)
summary(lm_shannon)

lm_richness <- lm(Richness ~ Latitude, data = diversity_data)
summary(lm_richness)
#Non-significant

#Let's run a linear model without Ramnagar
diversity_data1 <- diversity_data %>%
  filter(!Site == "Ramnagar")
lm_shannon1 <- lm(Shannon ~ Latitude, data = diversity_data1)
summary(lm_shannon1)
#Not significant

lm_richness1 <- lm(Richness ~ Latitude, data = diversity_data1)
summary(lm_richness1)
#Significant

r_squared_shannon <- summary(lm_shannon)$r.squared
r_squared_richness <- summary(lm_richness)$r.squared

p_value_shannon <- summary(lm_shannon)$coefficients[2, 4]
p_value_richness <- summary(lm_richness)$coefficients[2, 4]

label_shannon <- paste0("R² = ", format(r_squared_shannon, digits = 3), 
                        ", p-value = ", format(p_value_shannon, digits = 3))
label_richness <- paste0("R² = ", format(r_squared_richness, digits = 3), 
                         ", p-value = ", format(p_value_richness, digits = 3))

richness_plot <- ggplot(diversity_data, aes(x = Latitude, y = Richness)) +
  geom_jitter(
    size = 3.5,
    width = 0.1,
    height = 0.1,
    alpha = 0.7,
    color = "olivedrab"
  ) +
  geom_smooth(method = "lm", se = FALSE, color = "slategrey", size = 2) +
  xlab("Latitude") +
  ylab("Species richness") +
  theme_classic() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(size = base_size * 1.7),
    axis.title = element_text(size = base_size * 1.4),
    axis.text = element_text(size = base_size * 1.3),
    legend.position = "none",
    plot.margin = margin(10, 10, 10, 10)
  ) +
  annotate(
    "text",
    x = Inf,
    y = Inf,
    label = label_richness,
    hjust = 1.1,
    vjust = 2,
    size = 5,
    color = "black"
  )

shannon_plot <- ggplot(diversity_data, aes(x = Latitude, y = Shannon)) +
  geom_jitter(
    alpha = 0.7,
    width = 0.1,
    height = 0.1,
    size = 3.5,
    color = "olivedrab"
  ) +
  geom_smooth(method = "lm", se = FALSE, color = "slategrey", size = 2) +
  xlab("Latitude") +
  ylab("Shannon diversity") +
  theme_classic() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(size = base_size * 1.7),
    axis.title = element_text(size = base_size * 1.4),
    axis.text = element_text(size = base_size * 1.3),
    legend.position = "none",
    plot.margin = margin(10, 10, 10, 10)
  ) +
  annotate(
    "text",
    x = Inf,
    y = Inf,
    label = label_shannon,
    hjust = 1.1,
    vjust = 2,
    size = 5,
    color = "black"
  )


#Combine 
divplot <- richness_plot + shannon_plot + plot_layout(guides = 'collect') & theme(legend.position = 'none') 

#ggsave(filename = "diversity1s.png", plot = divplot, width = 10, height = 6, dpi = 300)

#Calculating distances 
par(mfrow = c(1, 2))
bray = vegdist(sp_final, "bray") 
gower = vegdist(sp_final, "gower")
hist(bray, xlim = range(0.0,1.0))
hist(gower, xlim = range(0.0,1.0))

par(mfrow = c(1, 2))
plot(bray)
plot(gower)

spAbund <- rowSums(sp_final)  #gives the number of individuals found in each plot
spAbund #view observations per plot 

raremin <- min(rowSums(sp_final))


#NMDS
sp_nmds  <- sp_arranged %>% 
  dplyr::select(-Lat)

spnmds <- as.data.frame(sp_nmds)

rownames(spnmds) = spnmds[,1]

#Remove the first column from the data frame
spnmds = spnmds[,-1]

NMDS=metaMDS(spnmds, k=2)

#Basic NMDS plot
#plot NMDS with site names and ant species

plot(NMDS)

dev.new()
ordiplot(NMDS, type ='n') #Ordination plot function especially for congested plots
orditorp(NMDS,display="species",col="red",air=0.01) #The function adds text or points to ordination plots
orditorp(NMDS,display="sites",cex=1.25,air=0.01)

sites_scores <- scores(NMDS, display = "sites")
df_sites <- as.data.frame(sites_scores)
df_sites$Latitude <- sp_arranged$Lat


#Normalize latitude values to range between 0 and 1
normalized_lat <- (sp_arranged$Lat - min(sp_arranged$Lat)) / (max(sp_arranged$Lat) - min(sp_arranged$Lat))

#Use a color gradient function to map normalized latitudes to colors
colors <- colorRampPalette(c("#9F025E", "#F9C929"))(length(unique(normalized_lat)))
site_colors <- colors[rank(normalized_lat)]


#Plotting
ordiplot(NMDS, type = 'n')
orditorp(NMDS, display = "species", col = "black", air = 0.01)


#Add a legend for color gradient
species_scores <- scores(NMDS, display = "species")
site_scores <- scores(NMDS, display = "sites")


#Ensure species names are unique in the data
species_data <- data.frame(
  NMDS1 = species_scores[, 1],
  NMDS2 = species_scores[, 2],
  Species = make.unique(rownames(species_scores))
)

#Create a data frame for site scores with site names, latitude, and categories
site_data <- data.frame(
  NMDS1 = site_scores[, 1],
  NMDS2 = site_scores[, 2],
  Site = rownames(site_scores),
  Latitude = diversity_data$Latitude
)


p_nmds <- ggplot() +
  geom_point(
    data = site_data,
    aes(x = NMDS1, y = NMDS2),
    shape = 21,
    size = 6,
    color = "olivedrab",
    fill = "olivedrab"
  ) +
  
  # Site labels: colored by Latitude
  geom_text(
    data = site_data,
    aes(x = NMDS1, y = NMDS2, label = Site, color = Latitude),
    size = 6,
    nudge_y = 0.2
  ) +
  
  # Continuous color gradient for Latitude
  scale_color_gradient(
    low = "#9F025E", high = "#F9C929", name = "Latitude"
  ) +
  
  # Axis labels
  labs(x = "NMDS1", y = "NMDS2") +
  
  # Theme
  theme_classic() +
  theme(
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 16),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )


#ggsave(filename = "nmds.png", plot = p_nmds, width = 11, height = 6, dpi = 300)

#Combine all community plots
comm_plot <- (divplot / p_nmds)  + plot_annotation(tag_levels = 'a') &
  theme(plot.tag = element_text(size = 25))    # Using | ensures side-by-side layout

ggsave(filename = "figure3.png", plot = comm_plot, width = 12, height = 14, dpi = 300)

#Calculate PERMANOVA scores
bray_curtis <- vegdist(spnmds, method = "bray")

permanova_result <- adonis2(bray_curtis ~ sp_arranged$Lat, data = sp_arranged, permutations = 999)
print(permanova_result)
#Significant 

```
##Structural equation modelling

We implemented a structural equation model using the lavaan package to 
further understand relationships between variables.

```{r structural equation modelling}

#Subsetting dataset to contain relevant variables

semdata <- data[, c("Plant.ID", "Latitude", "width", "EFNLB", "EFNS", "pherb", "average_abundance", "fruitno", "Area_Leafbase", "Area_Petiole", "Vol_Leafbase", "Vol_Petiole")]

semdata_standardized <- as.data.frame(scale(semdata[, -1]))  #Scaling all except Plant.ID
semdata_standardized$Plant.ID <- semdata$Plant.ID  #Add back the Plant.ID

# Inspect the standardized data
summary(semdata_standardized)

#model specification
model12 <- '
  average_abundance ~ Latitude + EFNLB + EFNS
  pherb ~ Latitude + average_abundance + EFNLB + EFNS
  EFNLB ~ Latitude + width + pherb 
  EFNS ~ Latitude + width + pherb
  fruitno ~ pherb + average_abundance + Latitude + EFNLB + EFNS +  width 
 '

rev_fit <- sem(model12, data = semdata_standardized, std.lv = TRUE)

#Evaluate the model
revfit_summary <- summary(rev_fit, fit.measures = TRUE, standardized = TRUE, rsquare = TRUE)


#pherb and Area_Leafbase have -ve R2 values
#Suggests they are misspecified, the variables/models don't sufficiently 
#explain variation in these variables

#25 November 2024 - trying another model without EFN predicted by herbivory
#To remove circularity

model121 <- '
  average_abundance ~ Latitude + EFNLB + EFNS
  pherb ~ Latitude + average_abundance + EFNLB + EFNS
  EFNLB ~ Latitude + width  
  EFNS ~ Latitude + width 
  fruitno ~ pherb + average_abundance + Latitude + EFNLB + EFNS +  width 
 '
rev_fit1 <- sem(model121, data = semdata_standardized, std.lv = TRUE)

#Evaluate the model
revfit_summary1 <- summary(rev_fit1, fit.measures = TRUE, standardized = TRUE, rsquare = TRUE)

#Negative R-squared goes away when circular dependencies are removed
#Much poorer fit than model12

#Checking for collinearity between variables

#Subset predictors of an endogenous variable
predictors <- semdata_standardized[, c("Latitude", "width", "EFNLB", "EFNS", "pherb", "average_abundance", "fruitno")]

#Compute correlation matrix
cor_matrix <- cor(predictors, use = "complete.obs")

#Visualize
corrplot(cor_matrix, method = "circle")

#Nothing concerning

#Inspect VIF values

vif_ab <- lm(average_abundance ~ Latitude + EFNLB + EFNS, data = semdata_standardized)
vif_herb <- lm(pherb ~  Latitude + average_abundance + EFNLB + EFNS, data = semdata_standardized)
vif_lb <- lm( EFNLB ~ Latitude + width, data = semdata_standardized)
vif_s <- lm(EFNS ~ Latitude + width, data = semdata_standardized )
vif_fru <- lm(fruitno ~ pherb + average_abundance + Latitude + EFNLB + EFNS +  width, data = semdata_standardized)

#Compute VIF
vif(vif_ab)
vif(vif_herb)
vif(vif_lb)
vif(vif_s)
vif(vif_fru)

#collinearity not an issue

#Adding correlated errors

model122 <- '
  average_abundance ~ Latitude + EFNLB + EFNS
  pherb ~ Latitude + average_abundance + EFNLB + EFNS
  EFNLB ~ Latitude + width  
  EFNS ~ Latitude + width 
  fruitno ~ pherb + average_abundance + Latitude + EFNLB + EFNS +  width 
  EFNS ~~ EFNLB
 '
rev_fit2 <- sem(model122, data = semdata_standardized, std.lv = TRUE)

#Evaluate the model
revfit_summary2 <- summary(rev_fit2, fit.measures = TRUE, standardized = TRUE, rsquare = TRUE)

#This model meets specifications and has positive R-squared values

#Simplified model in which directly non-explainable links for fruit number are removed

model123 <- '
  average_abundance ~ Latitude + EFNLB + EFNS
  pherb ~ Latitude + average_abundance + EFNLB + EFNS
  EFNLB ~ Latitude + width  
  EFNS ~ Latitude + width 
  fruitno ~ pherb + average_abundance + Latitude + width 
  EFNS ~~ EFNLB
 '
rev_fit3 <- sem(model123, data = semdata_standardized, std.lv = TRUE)

#Evaluate the model
revfit_summary3 <- summary(rev_fit3, fit.measures = TRUE, standardized = TRUE, rsquare = TRUE)

#Good fit, best model so far but goodness of fit indices lower than model122

#Same model as above, but with indirect effects of EFN on fruits

model124 <- '
  # Direct effects
  average_abundance ~ c1*Latitude + c9*EFNLB + c2*EFNS
  pherb ~ c3*Latitude + c4*average_abundance + c10*EFNLB + c5*EFNS
  fruitno ~ c6*pherb + c7*average_abundance + c8*Latitude + width
  EFNLB ~ Latitude + width
  EFNS ~ Latitude + width
  EFNS ~~ EFNLB
  
  # Indirect effects of EFNs on fruit number
  ind_efnlb := c9 * c4 * c6  # EFNLB → average_abundance → pherb → fruitno
  ind_efns := c2 * c4 * c6   # EFNS → average_abundance → pherb → fruitno
'

rev_fit4 <- sem(model124, data = semdata_standardized, std.lv = TRUE)

#Evaluate the model
revfit_summary4 <- summary(rev_fit4, fit.measures = TRUE, standardized = TRUE, rsquare = TRUE)

#model124 has good fit but no evidence of indirect effects

#Use direct AND indirect effects - what if there is some genetics?

model125 <- '
  # Direct effects
  average_abundance ~ c1*Latitude + c9*EFNLB + c2*EFNS
  pherb ~ c3*Latitude + c4*average_abundance + c10*EFNLB + c5*EFNS
  fruitno ~ c6*pherb + c7*average_abundance + c8*Latitude + EFNLB + EFNS + width
  EFNLB ~ Latitude + width
  EFNS ~ Latitude + width
  EFNS ~~ EFNLB
  
  # Indirect effects of EFNs on fruit number
  ind_efnlb := c9 * c4 * c6  # EFNLB → average_abundance → pherb → fruitno
  ind_efns := c2 * c4 * c6   # EFNS → average_abundance → pherb → fruitno
'

rev_fit5 <- sem(model125, data = semdata_standardized, std.lv = TRUE)

#Evaluate the model
revfit_summary5 <- summary(rev_fit5, fit.measures = TRUE, standardized = TRUE, rsquare = TRUE)

#Best model

#Final model

###Make Figure 4
sem_apriori <- ggdraw() + draw_image("Slide2_cropped.PNG")
sem_sig <- ggdraw() + draw_image("Slide3_cropped.PNG")

sem_plot <- (sem_apriori / sem_sig)  + plot_annotation(tag_levels = 'a') &
  theme(plot.tag = element_text(size = 25))  

ggsave(filename = "figure4.png", plot = sem_plot, width = 12, height = 12, dpi = 300)

```
#Common garden results

```{r Common garden results}
df <- read.csv("common_garden_data.csv")

#adding NAs in blank cells
df$leaf_touch <- na_if(df$leaf_touch, "")

#subsetting to only round 2
df <- df[df$round== 2,]

#removing NAs in the ant exclusion column
df <- df %>% 
  filter(!is.na(ant_exc))

#Plot herbivory in round 2 for excluded (non touching), excluded plants

#removing excluded rows for which leaves were touching 
df <- df %>% 
  filter(!leaf_touch == "Yes")

#Herbivory

#calculate sample sizes

df_n <- df %>%
  group_by(ant_exc) %>%
  summarize(n = n())

p4 <- ggplot(df, aes(x = ant_exc, y = prop_herb, fill = ant_exc)) +
  geom_boxplot() +
  labs(x = "Ant exclusion", 
       y = "Herbivory (proportion of leaves)")+
  scale_fill_manual(values = c("Yes" = "green", "No" = "yellow"), 
                    labels = c("Yes" = "Excluded", "No" = "Control")) +
  
  theme_classic() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 14),
    legend.position = "none"
  ) +
  annotate("text", x = 1.5, y = 0.95, label = "*", size = 13)

#Add sample sizes
p4_n <- p4 + 
  geom_text(
    data = df_n,
    aes(
      x = ant_exc, 
      y = 0.08,   # Adjust to position text where you want it
      label = paste0("n=", n)
    ),
    vjust = -1,   # Nudges text upward/downward
    size = 5
  )

ggsave(filename = "ant_exc_herb.png", plot = p4_n, width = 6, height = 6, dpi = 300)

m1 <- lm(prop_herb ~ ant_exc + ant_ab_all, data = df)
summary(m1)
anova(m1)
```
